(function(){"use strict";const p={energy:0,treble:1,bass:2,mids:3,highs:4,lows:5,beat:6},R=globalThis.__sveltekit_8ak8jc?.base??"/soundart";globalThis.__sveltekit_8ak8jc?.assets;const S=new Map;async function U(t){if(S.has(t))return S.get(t);const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load shader: ${t}`);const i=await e.text();return S.set(t,i),i}async function A(t,e,i=new Set){const r=/#include\s+"([^"]+)"/g;let a=t,o;const l=[];for(;(o=r.exec(t))!==null;)l.push({full:o[0],path:o[1]});for(const{full:d,path:m}of l){const h=e+m;if(i.has(h)){console.warn(`Circular include detected: ${h}`),a=a.replace(d,"");continue}i.add(h);try{let L=await U(h);L=await A(L,e,i),a=a.replace(d,L)}catch(L){console.error(`Failed to include shader: ${h}`,L),a=a.replace(d,`// Failed to include: ${m}`)}}return a}async function x(t,e=`${R}/shaders/`){const i=await U(e+t);return A(i,e)}function _(t,e,i){const r=t.createShader(e);if(!r)return console.error("Failed to create shader"),null;if(t.shaderSource(r,i),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){const a=t.getShaderInfoLog(r);console.error("Shader compilation error:",a);const l=i.split(`
`).map((d,m)=>`${m+1}: ${d}`);return console.error(`Shader source:
`+l.join(`
`)),t.deleteShader(r),null}return r}function M(t,e,i){const r=_(t,t.VERTEX_SHADER,e),a=_(t,t.FRAGMENT_SHADER,i);if(!r||!a)return null;const o=t.createProgram();if(!o)return console.error("Failed to create program"),null;if(t.attachShader(o,r),t.attachShader(o,a),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS)){const l=t.getProgramInfoLog(o);return console.error("Program linking error:",l),t.deleteProgram(o),null}return t.deleteShader(r),t.deleteShader(a),o}async function P(t,e,i,r=`${R}/shaders/`){const[a,o]=await Promise.all([x(e,r),x(i,r)]);return M(t,a,o)}const s=(t,e,i,r,a,o,l=.01,d=!0,m,h)=>({id:t,label:e,type:"float",default:i,min:r,max:a,step:l,uniform:o,randomizable:d,randomMin:m,randomMax:h}),f=(t,e,i,r,a,o,l=1,d=!0,m,h)=>({id:t,label:e,type:"int",default:i,min:r,max:a,step:l,uniform:o,randomizable:d,randomMin:m,randomMax:h}),F=(t,e,i,r,a,o=!0)=>({id:t,label:e,type:"select",default:i,options:r,uniform:a,randomizable:o}),u=(t,e)=>{const i=`uLayer${t.charAt(0).toUpperCase()+t.slice(1)}`;return[s("intensity","Intensity",.5,0,1,`${i}`),s("speed","Speed",1,0,3,`${i}Speed`),s("zoom","Zoom",1,.5,2,`${i}Zoom`),F("theme","Theme",0,[],`${i}Theme`)]},I=[{id:"mandala",label:"Mandala",description:"Radial symmetries",properties:[...u("mandala"),f("segments","Segments",6,4,32,"uLayerMandalaSegments"),s("rotation","Rotation",.2,-1,1,"uLayerMandalaRotation"),{id:"symmetry",label:"Symmetry",type:"boolean",default:!0,uniform:"uLayerMandalaSymmetry",randomizable:!0,ui:{shortLabel:"Sym",tooltip:"Toggle mirrored symmetry on/off"}}],shaderPath:"layers/mandala.glsl",randomizable:!0},{id:"kaleidoscope",label:"Kaleidoscope",description:"Sacred geometry mirroring",properties:[...u("kaleidoscope"),f("slices","Slices",6,6,24,"uLayerKaleidoscopeSlices"),s("feedback","Feedback",.5,0,.95,"uLayerKaleidoscopeFeedback"),s("distortion","Distortion",.5,0,2,"uLayerKaleidoscopeDistortion")],shaderPath:"layers/kaleidoscope.glsl",randomizable:!0},{id:"metatron",label:"Metatron's Cube",description:"Sacred geometry with nested rings",properties:[...u("metatron"),f("rings","Rings",2,1,10,"uLayerMetatronRings"),s("thickness","Thickness",.008,.001,.02,"uLayerMetatronThickness",.001,!0,.003,.015),s("spin","Spin",.5,-2,2,"uLayerMetatronSpin")],shaderPath:"layers/metatron.glsl",randomizable:!0},{id:"lissajous",label:"Lissajous",description:"Symmetric line trails",properties:[...u("lissajous"),{id:"frequencies",label:"Complexity",type:"float",default:3,min:1,max:10,step:.1,uniform:"uLayerLissajousFrequencies",randomizable:!0,randomMin:2,randomMax:8,ui:{shortLabel:"Cplx",tooltip:"Curve frequency ratio / knot complexity"}},{id:"slices",label:"Symmetry",type:"int",default:8,min:3,max:24,step:1,uniform:"uLayerLissajousSlices",randomizable:!0,randomMin:4,randomMax:16,ui:{shortLabel:"Sym",tooltip:"Kaleidoscope slices (higher = more symmetry)"}},{id:"damping",label:"Trail Decay",type:"float",default:.1,min:0,max:1,step:.01,uniform:"uLayerLissajousDamping",randomizable:!0,randomMin:0,randomMax:.8,ui:{shortLabel:"Decy",tooltip:"Higher = shorter trail"}},{id:"thickness",label:"Line Width",type:"float",default:.008,min:.001,max:.02,step:.001,uniform:"uLayerLissajousThickness",randomizable:!0,randomMin:.003,randomMax:.012,ui:{shortLabel:"Line",tooltip:"Line thickness"}}],shaderPath:"layers/lissajous.glsl",randomizable:!0},{id:"turbulence",label:"Turbulence",description:"Audio-reactive turbulence",properties:[...u("turbulence"),f("complexity","Complexity",3,1,6,"uLayerTurbulenceComplexity"),s("flow","Flow",.5,-1,1,"uLayerTurbulenceFlow")],shaderPath:"layers/turbulence.glsl",randomizable:!0},{id:"displacement",label:"Displacement",description:"Cellular displacement waves",properties:[...u("displacement"),s("strength","Strength",.5,0,2,"uLayerDisplacementStrength"),s("cellSize","Cell Size",1,.1,5,"uLayerDisplacementCellSize"),s("ripple","Ripple",1,0,3,"uLayerDisplacementRipple")],shaderPath:"layers/displacement.glsl",randomizable:!0},{id:"glow",label:"Center Glow",description:"Pulsing core with arcs",properties:[...u("glow"),s("coreSize","Core Size",.5,.1,2,"uLayerGlowCoreSize"),f("ringCount","Ring Count",3,0,10,"uLayerGlowRingCount"),s("arcIntensity","Arc Intensity",.5,0,2,"uLayerGlowArcIntensity")],shaderPath:"layers/glow.glsl",randomizable:!0},{id:"starfield",label:"Starfield",description:"Warp tunnel streaks",properties:[...u("starfield"),s("density","Density",1,.1,3,"uLayerStarfieldDensity"),s("warp","Warp",1,.1,5,"uLayerStarfieldWarp"),f("layers","Layers",4,1,8,"uLayerStarfieldLayers")],shaderPath:"layers/starfield.glsl",randomizable:!0},{id:"hopalong",label:"Hopalong Orbits",description:"Barry Martin attractor with kaleidoscope splits",properties:[...u("hopalong"),s("divergence","Divergence",1,.1,5,"uLayerHopalongDivergence"),f("iterations","Iterations",50,10,200,"uLayerHopalongIterations"),f("slices","Slices",1,1,16,"uLayerHopalongSlices",1,!0,1,12),s("rotation","Rotation",0,-1,1,"uLayerHopalongRotation",.01,!0,-.5,.5)],shaderPath:"layers/hopalong.glsl",randomizable:!0}];class C{gl;program=null;uniformLocations={};mouseUniformLocations={};layerUniformLocations=new Map;feedbackTexture=null;feedbackReady=!1;feedbackWidth=0;feedbackHeight=0;positionBuffer=null;initialized=!1;width=0;height=0;uniformCache=new Map;constructor(e){this.gl=e}async init(){const e=this.gl;try{if(this.program=await P(e,"quad.vert","composite.frag"),!this.program)return console.error("WorkerRenderer: Failed to create shader program"),!1}catch(a){return console.error("WorkerRenderer: Failed to load shaders:",a),!1}this.uniformLocations={time:e.getUniformLocation(this.program,"uTime"),resolution:e.getUniformLocation(this.program,"uResolution"),beat:e.getUniformLocation(this.program,"uBeat"),energy:e.getUniformLocation(this.program,"uEnergy"),treble:e.getUniformLocation(this.program,"uTreble"),feedbackTexture:e.getUniformLocation(this.program,"uFeedbackTex"),feedbackReady:e.getUniformLocation(this.program,"uFeedbackReady")},this.mouseUniformLocations={position:e.getUniformLocation(this.program,"uMouse"),velocity:e.getUniformLocation(this.program,"uMouseVelocity"),speed:e.getUniformLocation(this.program,"uMouseSpeed"),down:e.getUniformLocation(this.program,"uMouseDown"),click:e.getUniformLocation(this.program,"uMouseClick")};for(const a of I)for(const o of a.properties){const l=e.getUniformLocation(this.program,o.uniform);this.layerUniformLocations.set(o.uniform,l)}this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer);const i=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);e.bufferData(e.ARRAY_BUFFER,i,e.STATIC_DRAW);const r=e.getAttribLocation(this.program,"aPosition");return e.enableVertexAttribArray(r),e.vertexAttribPointer(r,2,e.FLOAT,!1,0,0),this.feedbackTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.feedbackTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),this.initialized=!0,!0}resize(e,i){if(!this.gl)return;const r=Math.floor(e),a=Math.floor(i);this.width=r,this.height=a,this.gl.viewport(0,0,r,a),this.feedbackTexture&&(this.gl.bindTexture(this.gl.TEXTURE_2D,this.feedbackTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGB,r,a,0,this.gl.RGB,this.gl.UNSIGNED_BYTE,null),this.feedbackWidth=r,this.feedbackHeight=a),this.feedbackReady=!1}updateLayers(e){if(!(!this.gl||!this.program)){this.gl.useProgram(this.program);for(const i of e)for(const[r,a]of Object.entries(i.uniforms))this.setUniform(r,a)}}updateMouse(e){!this.gl||!this.program||(this.gl.useProgram(this.program),this.gl.uniform2f(this.mouseUniformLocations.position,e.x,e.y),this.gl.uniform2f(this.mouseUniformLocations.velocity,e.velocityX,e.velocityY),this.gl.uniform1f(this.mouseUniformLocations.speed,e.speed),this.gl.uniform1f(this.mouseUniformLocations.down,e.down),this.gl.uniform2f(this.mouseUniformLocations.click,e.clickX,e.clickY))}render(e,i){if(!this.gl||!this.program||!this.initialized)return;const r=this.gl;r.clearColor(0,0,0,1),r.clear(r.COLOR_BUFFER_BIT),r.useProgram(this.program),r.bindBuffer(r.ARRAY_BUFFER,this.positionBuffer);const a=r.getAttribLocation(this.program,"aPosition");if(r.enableVertexAttribArray(a),r.vertexAttribPointer(a,2,r.FLOAT,!1,0,0),r.uniform1f(this.uniformLocations.time,e),r.uniform2f(this.uniformLocations.resolution,this.width,this.height),r.uniform1f(this.uniformLocations.beat,i.beat),r.uniform1f(this.uniformLocations.energy,i.energy),r.uniform1f(this.uniformLocations.treble,i.treble),r.activeTexture(r.TEXTURE0),this.feedbackTexture&&this.feedbackReady?r.bindTexture(r.TEXTURE_2D,this.feedbackTexture):r.bindTexture(r.TEXTURE_2D,null),r.uniform1i(this.uniformLocations.feedbackTexture,0),r.uniform1f(this.uniformLocations.feedbackReady,this.feedbackReady?1:0),r.drawArrays(r.TRIANGLES,0,6),this.width>0&&this.height>0&&this.feedbackTexture){r.bindTexture(r.TEXTURE_2D,this.feedbackTexture);const o=Math.min(this.feedbackWidth,r.drawingBufferWidth,this.width),l=Math.min(this.feedbackHeight,r.drawingBufferHeight,this.height);o>0&&l>0&&(r.copyTexSubImage2D(r.TEXTURE_2D,0,0,0,0,0,o,l),this.feedbackReady=!0)}}setUniform(e,i){if(this.uniformCache.get(e)===i)return;const r=this.layerUniformLocations.get(e);r&&(this.gl.uniform1f(r,i),this.uniformCache.set(e,i))}}let y=null,T=null,c=null,b=!1,g=null;const n={energy:0,treble:0,bass:0,mids:0,highs:0,lows:0,beat:0};self.onmessage=async t=>{const e=t.data;switch(e.type){case"INIT":if(console.log("[RenderWorker] Received INIT"),y=e.canvas,e.audioBuffer?(console.log("[RenderWorker] Using SharedArrayBuffer"),c=new Float32Array(e.audioBuffer)):console.log("[RenderWorker] Using message passing for audio updates"),e.dpr,T=y.getContext("webgl",{antialias:!1,preserveDrawingBuffer:!0,alpha:!1}),!T){console.error("Worker: WebGL not supported");return}if(g=new C(T),!await g.init()){console.error("Worker: Failed to initialize renderer");return}b=!0,requestAnimationFrame(w);break;case"RESIZE":if(y){const r=e.width*e.dpr,a=e.height*e.dpr;y.width=r,y.height=a,e.dpr,g?.resize(r,a)}break;case"UPDATE_CONFIG":g?.updateLayers(e.layers);break;case"UPDATE_PARAMS":g?.updateMouse(e.mouse);break;case"SET_AUDIO_BUFFER":console.log("[RenderWorker] Received SharedArrayBuffer"),c=new Float32Array(e.audioBuffer);break;case"UPDATE_AUDIO":e.metrics&&(n.energy=e.metrics.energy,n.treble=e.metrics.treble,n.bass=e.metrics.bass,n.mids=e.metrics.mids,n.highs=e.metrics.highs,n.lows=e.metrics.lows,n.beat=e.metrics.beat);break;case"PAUSE":b=!1;break;case"RESUME":b||(b=!0,requestAnimationFrame(w));break}};function z(){c&&(n.energy=c[p.energy],n.treble=c[p.treble],n.bass=c[p.bass],n.mids=c[p.mids],n.highs=c[p.highs],n.lows=c[p.lows],n.beat=c[p.beat])}let D=0,k=0,E=0;function w(t){if(!(!b||!T)){if(z(),g?.render(t/1e3,n),k++,t-E>=1e3){const e=Math.round(k*1e3/(t-E));self.postMessage({type:"STATS",fps:e,frameTime:t-D}),E=t,k=0}D=t,requestAnimationFrame(w)}}})();
