(function(){"use strict";const g={energy:0,treble:1,bass:2,mids:3,highs:4,lows:5,beat:6},E=globalThis.__sveltekit_5xqrnh?.base??"/soundart";globalThis.__sveltekit_5xqrnh?.assets;const U=new Map;async function w(r){if(U.has(r))return U.get(r);const e=await fetch(r);if(!e.ok)throw new Error(`Failed to load shader: ${r}`);const i=await e.text();return U.set(r,i),i}async function A(r,e,i=new Set){const t=/#include\s+"([^"]+)"/g;let a=r,o;const s=[];for(;(o=t.exec(r))!==null;)s.push({full:o[0],path:o[1]});for(const{full:u,path:d}of s){const f=e+d;if(i.has(f)){console.warn(`Circular include detected: ${f}`),a=a.replace(u,"");continue}i.add(f);try{let L=await w(f);L=await A(L,e,i),a=a.replace(u,L)}catch(L){console.error(`Failed to include shader: ${f}`,L),a=a.replace(u,`// Failed to include: ${d}`)}}return a}async function x(r,e=`${E}/shaders/`){const i=await w(e+r);return A(i,e)}function D(r,e,i){const t=r.createShader(e);if(!t)return console.error("Failed to create shader"),null;if(r.shaderSource(t,i),r.compileShader(t),!r.getShaderParameter(t,r.COMPILE_STATUS)){const a=r.getShaderInfoLog(t);console.error("Shader compilation error:",a);const s=i.split(`
`).map((u,d)=>`${d+1}: ${u}`);return console.error(`Shader source:
`+s.join(`
`)),r.deleteShader(t),null}return t}function P(r,e,i){const t=D(r,r.VERTEX_SHADER,e),a=D(r,r.FRAGMENT_SHADER,i);if(!t||!a)return null;const o=r.createProgram();if(!o)return console.error("Failed to create program"),null;if(r.attachShader(o,t),r.attachShader(o,a),r.linkProgram(o),!r.getProgramParameter(o,r.LINK_STATUS)){const s=r.getProgramInfoLog(o);return console.error("Program linking error:",s),r.deleteProgram(o),null}return r.deleteShader(t),r.deleteShader(a),o}async function _(r,e,i,t=`${E}/shaders/`){const[a,o]=await Promise.all([x(e,t),x(i,t)]);return P(r,a,o)}const n=(r,e,i,t,a,o,s=.01,u=!0,d,f)=>({id:r,label:e,type:"float",default:i,min:t,max:a,step:s,uniform:o,randomizable:u,randomMin:d,randomMax:f}),p=(r,e,i,t,a,o,s=1,u=!0,d,f)=>({id:r,label:e,type:"int",default:i,min:t,max:a,step:s,uniform:o,randomizable:u,randomMin:d,randomMax:f}),C=(r,e,i,t,a,o=!0)=>({id:r,label:e,type:"select",default:i,options:t,uniform:a,randomizable:o}),m=(r,e)=>{const i=`uLayer${r.charAt(0).toUpperCase()+r.slice(1)}`;return[n("intensity","Intensity",.5,0,1,`${i}`),n("speed","Speed",1,0,3,`${i}Speed`),n("zoom","Zoom",1,.5,2,`${i}Zoom`),C("theme","Theme",0,[],`${i}Theme`)]},F=[{id:"mandala",label:"Mandala",description:"Radial symmetries",properties:[...m("mandala"),p("segments","Segments",6,4,32,"uLayerMandalaSegments"),n("rotation","Rotation",.2,-1,1,"uLayerMandalaRotation"),{id:"symmetry",label:"Symmetry",type:"boolean",default:!0,uniform:"uLayerMandalaSymmetry",randomizable:!0,ui:{shortLabel:"Sym",tooltip:"Toggle mirrored symmetry on/off"}}],shaderPath:"layers/mandala.glsl",randomizable:!0},{id:"kaleidoscope",label:"Kaleidoscope",description:"Sacred geometry mirroring",properties:[...m("kaleidoscope"),p("slices","Slices",6,6,24,"uLayerKaleidoscopeSlices"),n("feedback","Feedback",.5,0,.95,"uLayerKaleidoscopeFeedback"),n("distortion","Distortion",.5,0,2,"uLayerKaleidoscopeDistortion")],shaderPath:"layers/kaleidoscope.glsl",randomizable:!0},{id:"metatron",label:"Metatron's Cube",description:"Sacred geometry with nested rings",properties:[...m("metatron"),p("rings","Rings",2,1,10,"uLayerMetatronRings"),n("thickness","Thickness",.008,.001,.02,"uLayerMetatronThickness",.001,!0,.003,.015),n("spin","Spin",.5,-2,2,"uLayerMetatronSpin")],shaderPath:"layers/metatron.glsl",randomizable:!0},{id:"lissajous",label:"Lissajous",description:"Symmetric line trails",properties:[...m("lissajous"),{id:"frequencies",label:"Complexity",type:"float",default:3,min:1,max:10,step:.1,uniform:"uLayerLissajousFrequencies",randomizable:!0,randomMin:2,randomMax:8,ui:{shortLabel:"Cplx",tooltip:"Curve frequency ratio / knot complexity"}},{id:"slices",label:"Symmetry",type:"int",default:8,min:3,max:24,step:1,uniform:"uLayerLissajousSlices",randomizable:!0,randomMin:4,randomMax:16,ui:{shortLabel:"Sym",tooltip:"Kaleidoscope slices (higher = more symmetry)"}},{id:"damping",label:"Trail Decay",type:"float",default:.1,min:0,max:1,step:.01,uniform:"uLayerLissajousDamping",randomizable:!0,randomMin:0,randomMax:.8,ui:{shortLabel:"Decy",tooltip:"Higher = shorter trail"}},{id:"thickness",label:"Line Width",type:"float",default:.008,min:.001,max:.02,step:.001,uniform:"uLayerLissajousThickness",randomizable:!0,randomMin:.003,randomMax:.012,ui:{shortLabel:"Line",tooltip:"Line thickness"}}],shaderPath:"layers/lissajous.glsl",randomizable:!0},{id:"cymatics",label:"Cymatics",description:"Standing-wave nodal line patterns",properties:[...m("cymatics"),{id:"mode",label:"Pattern Style",type:"select",default:0,options:[{value:0,label:"Plate"},{value:1,label:"Radial"},{value:2,label:"Hybrid"}],uniform:"uLayerCymaticsMode",randomizable:!0,ui:{shortLabel:"Style",tooltip:"Plate = grid-like patterns, Radial = circular patterns, Hybrid = mix of both"}},{id:"m",label:"Pattern Detail",type:"int",default:5,min:1,max:16,step:1,uniform:"uLayerCymaticsM",randomizable:!0,randomMin:2,randomMax:12,ui:{shortLabel:"Detail",tooltip:"Higher = more intricate pattern with more lines"}},{id:"n",label:"Pattern Complexity",type:"int",default:8,min:1,max:16,step:1,uniform:"uLayerCymaticsN",randomizable:!0,randomMin:3,randomMax:16,ui:{shortLabel:"Cplx",tooltip:"Higher = more complex wave patterns"}},{id:"thickness",label:"Line Width",type:"float",default:.06,min:.005,max:.2,step:.001,uniform:"uLayerCymaticsThickness",randomizable:!0,randomMin:.02,randomMax:.12,ui:{shortLabel:"Width",tooltip:"Thickness of the pattern lines (thinner = more delicate)"}},{id:"sharpness",label:"Line Sharpness",type:"float",default:1.4,min:.35,max:4,step:.05,uniform:"uLayerCymaticsSharpness",randomizable:!0,randomMin:.7,randomMax:2.6,ui:{shortLabel:"Sharp",tooltip:"Higher = crisper, more defined lines (lower = softer, more blurred)"}},{id:"warp",label:"Flow Distortion",type:"float",default:.35,min:0,max:1,step:.01,uniform:"uLayerCymaticsWarp",randomizable:!0,randomMin:0,randomMax:.85,ui:{shortLabel:"Flow",tooltip:"Adds flowing, wavy distortion to the pattern (0 = straight lines, higher = more movement)"}}],shaderPath:"layers/cymatics.glsl",randomizable:!0},{id:"turbulence",label:"Turbulence",description:"Audio-reactive turbulence",properties:[...m("turbulence"),p("complexity","Complexity",3,1,6,"uLayerTurbulenceComplexity"),n("flow","Flow",.5,-1,1,"uLayerTurbulenceFlow")],shaderPath:"layers/turbulence.glsl",randomizable:!0},{id:"displacement",label:"Displacement",description:"Cellular displacement waves",properties:[...m("displacement"),n("strength","Strength",.5,0,2,"uLayerDisplacementStrength"),n("cellSize","Cell Size",1,.1,5,"uLayerDisplacementCellSize"),n("ripple","Ripple",1,0,3,"uLayerDisplacementRipple")],shaderPath:"layers/displacement.glsl",randomizable:!0},{id:"glow",label:"Center Glow",description:"Pulsing core with arcs",properties:[...m("glow"),n("coreSize","Core Size",.5,.1,2,"uLayerGlowCoreSize"),p("ringCount","Ring Count",3,0,10,"uLayerGlowRingCount"),n("arcIntensity","Arc Intensity",.5,0,2,"uLayerGlowArcIntensity")],shaderPath:"layers/glow.glsl",randomizable:!0},{id:"starfield",label:"Starfield",description:"Warp tunnel streaks",properties:[...m("starfield"),n("density","Density",1,.1,3,"uLayerStarfieldDensity"),n("warp","Warp",1,.1,5,"uLayerStarfieldWarp"),p("layers","Layers",4,1,8,"uLayerStarfieldLayers")],shaderPath:"layers/starfield.glsl",randomizable:!0},{id:"hopalong",label:"Hopalong Orbits",description:"Barry Martin attractor with kaleidoscope splits",properties:[...m("hopalong"),n("divergence","Divergence",1,.1,5,"uLayerHopalongDivergence"),p("iterations","Iterations",5,1,10,"uLayerHopalongIterations"),p("slices","Slices",1,1,16,"uLayerHopalongSlices",1,!0,1,12),n("rotation","Rotation",0,-1,1,"uLayerHopalongRotation",.01,!0,-.5,.5)],shaderPath:"layers/hopalong.glsl",randomizable:!0}];class z{gl;program=null;uniformLocations={};mouseUniformLocations={};gestureUniformLocations={};layerUniformLocations=new Map;feedbackTexture=null;feedbackReady=!1;feedbackWidth=0;feedbackHeight=0;gestureData=null;positionBuffer=null;initialized=!1;width=0;height=0;uniformCache=new Map;qualityLevel=1;feedbackEnabled=!0;constructor(e){this.gl=e}async init(){const e=this.gl;try{if(this.program=await _(e,"quad.vert","composite.frag"),!this.program)return console.error("WorkerRenderer: Failed to create shader program"),!1}catch(a){return console.error("WorkerRenderer: Failed to load shaders:",a),!1}this.uniformLocations={time:e.getUniformLocation(this.program,"uTime"),resolution:e.getUniformLocation(this.program,"uResolution"),beat:e.getUniformLocation(this.program,"uBeat"),energy:e.getUniformLocation(this.program,"uEnergy"),treble:e.getUniformLocation(this.program,"uTreble"),feedbackTexture:e.getUniformLocation(this.program,"uFeedbackTex"),feedbackReady:e.getUniformLocation(this.program,"uFeedbackReady"),qualityLevel:e.getUniformLocation(this.program,"uQualityLevel")},this.mouseUniformLocations={position:e.getUniformLocation(this.program,"uMouse"),velocity:e.getUniformLocation(this.program,"uMouseVelocity"),speed:e.getUniformLocation(this.program,"uMouseSpeed"),down:e.getUniformLocation(this.program,"uMouseDown"),click:e.getUniformLocation(this.program,"uMouseClick")},this.gestureUniformLocations={handPositions:[e.getUniformLocation(this.program,"uGestureHandPositions[0]"),e.getUniformLocation(this.program,"uGestureHandPositions[1]"),e.getUniformLocation(this.program,"uGestureHandPositions[2]"),e.getUniformLocation(this.program,"uGestureHandPositions[3]")],handCount:e.getUniformLocation(this.program,"uGestureHandCount"),faceCenter:e.getUniformLocation(this.program,"uFaceCenter"),faceDetected:e.getUniformLocation(this.program,"uFaceDetected")};for(const a of F)for(const o of a.properties){const s=e.getUniformLocation(this.program,o.uniform);this.layerUniformLocations.set(o.uniform,s)}this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer);const i=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);e.bufferData(e.ARRAY_BUFFER,i,e.STATIC_DRAW);const t=e.getAttribLocation(this.program,"aPosition");return e.enableVertexAttribArray(t),e.vertexAttribPointer(t,2,e.FLOAT,!1,0,0),this.feedbackTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.feedbackTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([0,0,0,255])),this.initialized=!0,!0}resize(e,i){if(!this.gl)return;const t=Math.floor(e),a=Math.floor(i);this.width=t,this.height=a,this.gl.viewport(0,0,t,a),this.feedbackTexture&&(this.gl.bindTexture(this.gl.TEXTURE_2D,this.feedbackTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGB,t,a,0,this.gl.RGB,this.gl.UNSIGNED_BYTE,null),this.feedbackWidth=t,this.feedbackHeight=a),this.feedbackReady=!1}updateLayers(e){if(!(!this.gl||!this.program)){this.gl.useProgram(this.program);for(const i of e)for(const[t,a]of Object.entries(i.uniforms))this.setUniform(t,a)}}updateMouse(e){!this.gl||!this.program||(this.gl.useProgram(this.program),this.gl.uniform2f(this.mouseUniformLocations.position,e.x,e.y),this.gl.uniform2f(this.mouseUniformLocations.velocity,e.velocityX,e.velocityY),this.gl.uniform1f(this.mouseUniformLocations.speed,e.speed),this.gl.uniform1f(this.mouseUniformLocations.down,e.down),this.gl.uniform2f(this.mouseUniformLocations.click,e.clickX,e.clickY))}render(e,i){if(!this.gl||!this.program||!this.initialized)return;const t=this.gl;t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT),t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer);const a=t.getAttribLocation(this.program,"aPosition");if(t.enableVertexAttribArray(a),t.vertexAttribPointer(a,2,t.FLOAT,!1,0,0),t.uniform1f(this.uniformLocations.time,e),t.uniform2f(this.uniformLocations.resolution,this.width,this.height),t.uniform1f(this.uniformLocations.beat,i.beat),t.uniform1f(this.uniformLocations.energy,i.energy),t.uniform1f(this.uniformLocations.treble,i.treble),t.uniform1f(this.uniformLocations.qualityLevel,this.qualityLevel),this.gestureUniformLocations.handCount){const o=this.gestureData?.hands?.length||0;t.uniform1f(this.gestureUniformLocations.handCount,Math.min(o,4));for(let s=0;s<4;s++){const u=this.gestureUniformLocations.handPositions[s];if(u&&this.gestureData?.hands?.[s]?.center){const d=this.gestureData.hands[s];t.uniform2f(u,d.center.x,d.center.y)}else u&&t.uniform2f(u,.5,.5)}}if(this.gestureUniformLocations.faceCenter&&this.gestureUniformLocations.faceDetected)if(this.gestureData?.faces&&this.gestureData.faces.length>0){const o=this.gestureData.faces[0];t.uniform2f(this.gestureUniformLocations.faceCenter,o.center.x,o.center.y),t.uniform1f(this.gestureUniformLocations.faceDetected,1)}else t.uniform2f(this.gestureUniformLocations.faceCenter,.5,.5),t.uniform1f(this.gestureUniformLocations.faceDetected,0);if(t.activeTexture(t.TEXTURE0),this.feedbackEnabled&&this.feedbackTexture&&this.feedbackReady?t.bindTexture(t.TEXTURE_2D,this.feedbackTexture):t.bindTexture(t.TEXTURE_2D,null),t.uniform1i(this.uniformLocations.feedbackTexture,0),t.uniform1f(this.uniformLocations.feedbackReady,this.feedbackEnabled&&this.feedbackReady?1:0),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.enableVertexAttribArray(a),t.vertexAttribPointer(a,2,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLES,0,6),this.feedbackEnabled&&this.width>0&&this.height>0&&this.feedbackTexture){t.bindTexture(t.TEXTURE_2D,this.feedbackTexture);const o=Math.min(this.feedbackWidth,t.drawingBufferWidth,this.width),s=Math.min(this.feedbackHeight,t.drawingBufferHeight,this.height);o>0&&s>0&&(t.copyTexSubImage2D(t.TEXTURE_2D,0,0,0,0,0,o,s),this.feedbackReady=!0)}}updateQualityLevel(e){this.qualityLevel=e}updateFeedbackEnabled(e){this.feedbackEnabled=e}updateGestures(e){this.gestureData=e}setUniform(e,i){if(this.uniformCache.get(e)===i)return;const t=this.layerUniformLocations.get(e);t&&(this.gl.uniform1f(t,i),this.uniformCache.set(e,i))}}let b=null,T=null,h=null,y=!1,c=null;const l={energy:0,treble:0,bass:0,mids:0,highs:0,lows:0,beat:0};self.onmessage=async r=>{const e=r.data;switch(e.type){case"INIT":if(b=e.canvas,e.audioBuffer&&(h=new Float32Array(e.audioBuffer)),e.dpr,T=b.getContext("webgl",{antialias:!1,preserveDrawingBuffer:!0,alpha:!1}),!T){console.error("Worker: WebGL not supported");return}if(c=new z(T),!await c.init()){console.error("Worker: Failed to initialize renderer");return}y=!0,requestAnimationFrame(k);break;case"RESIZE":if(b){const t=e.width*e.dpr,a=e.height*e.dpr;b.width=t,b.height=a,e.dpr,c?.resize(t,a)}break;case"UPDATE_CONFIG":c?.updateLayers(e.layers);break;case"UPDATE_PARAMS":c?.updateMouse(e.mouse);break;case"UPDATE_MOUSE":c?.updateMouse(e.mouse);break;case"SET_AUDIO_BUFFER":h=new Float32Array(e.audioBuffer);break;case"UPDATE_AUDIO":e.metrics&&(l.energy=e.metrics.energy,l.treble=e.metrics.treble,l.bass=e.metrics.bass,l.mids=e.metrics.mids,l.highs=e.metrics.highs,l.lows=e.metrics.lows,l.beat=e.metrics.beat);break;case"UPDATE_QUALITY":c?.updateQualityLevel(e.quality);break;case"UPDATE_FEEDBACK":c?.updateFeedbackEnabled(e.enabled);break;case"CAMERA_FRAME":c?.updateCameraFrame(e.bitmap),e.gestures&&c?.updateGestures(e.gestures);break;case"UPDATE_GESTURES":c?.updateGestures(e.gestures);break;case"PAUSE":y=!1;break;case"RESUME":y||(y=!0,requestAnimationFrame(k));break}};function v(){h&&(l.energy=h[g.energy],l.treble=h[g.treble],l.bass=h[g.bass],l.mids=h[g.mids],l.highs=h[g.highs],l.lows=h[g.lows],l.beat=h[g.beat])}let M=0,S=0,R=0;function k(r){if(!(!y||!T)){if(v(),c?.render(r/1e3,l),S++,r-R>=1e3){const e=Math.round(S*1e3/(r-R));self.postMessage({type:"STATS",fps:e,frameTime:r-M}),R=r,S=0}M=r,requestAnimationFrame(k)}}})();
