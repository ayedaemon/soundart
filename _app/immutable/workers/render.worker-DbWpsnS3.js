(function(){"use strict";const g={energy:0,treble:1,bass:2,mids:3,highs:4,lows:5,beat:6},E=globalThis.__sveltekit_1ul1psi?.base??"/soundart";globalThis.__sveltekit_1ul1psi?.assets;const U=new Map;async function w(r){if(U.has(r))return U.get(r);const e=await fetch(r);if(!e.ok)throw new Error(`Failed to load shader: ${r}`);const a=await e.text();return U.set(r,a),a}async function A(r,e,a=new Set){const t=/#include\s+"([^"]+)"/g;let i=r,o;const n=[];for(;(o=t.exec(r))!==null;)n.push({full:o[0],path:o[1]});for(const{full:c,path:m}of n){const f=e+m;if(a.has(f)){console.warn(`Circular include detected: ${f}`),i=i.replace(c,"");continue}a.add(f);try{let L=await w(f);L=await A(L,e,a),i=i.replace(c,L)}catch(L){console.error(`Failed to include shader: ${f}`,L),i=i.replace(c,`// Failed to include: ${m}`)}}return i}async function x(r,e=`${E}/shaders/`){const a=await w(e+r);return A(a,e)}function D(r,e,a){const t=r.createShader(e);if(!t)return console.error("Failed to create shader"),null;if(r.shaderSource(t,a),r.compileShader(t),!r.getShaderParameter(t,r.COMPILE_STATUS)){const i=r.getShaderInfoLog(t);console.error("Shader compilation error:",i);const n=a.split(`
`).map((c,m)=>`${m+1}: ${c}`);return console.error(`Shader source:
`+n.join(`
`)),r.deleteShader(t),null}return t}function M(r,e,a){const t=D(r,r.VERTEX_SHADER,e),i=D(r,r.FRAGMENT_SHADER,a);if(!t||!i)return null;const o=r.createProgram();if(!o)return console.error("Failed to create program"),null;if(r.attachShader(o,t),r.attachShader(o,i),r.linkProgram(o),!r.getProgramParameter(o,r.LINK_STATUS)){const n=r.getProgramInfoLog(o);return console.error("Program linking error:",n),r.deleteProgram(o),null}return r.deleteShader(t),r.deleteShader(i),o}async function F(r,e,a,t=`${E}/shaders/`){const[i,o]=await Promise.all([x(e,t),x(a,t)]);return M(r,i,o)}const s=(r,e,a,t,i,o,n=.01,c=!0,m,f)=>({id:r,label:e,type:"float",default:a,min:t,max:i,step:n,uniform:o,randomizable:c,randomMin:m,randomMax:f}),p=(r,e,a,t,i,o,n=1,c=!0,m,f)=>({id:r,label:e,type:"int",default:a,min:t,max:i,step:n,uniform:o,randomizable:c,randomMin:m,randomMax:f}),_=(r,e,a,t,i,o=!0)=>({id:r,label:e,type:"select",default:a,options:t,uniform:i,randomizable:o}),d=(r,e)=>{const a=`uLayer${r.charAt(0).toUpperCase()+r.slice(1)}`;return[s("intensity","Intensity",.5,0,1,`${a}`),s("speed","Speed",1,0,3,`${a}Speed`),s("zoom","Zoom",1,.5,2,`${a}Zoom`),_("theme","Theme",0,[],`${a}Theme`)]},C=[{id:"mandala",label:"Mandala",description:"Radial symmetries",properties:[...d("mandala"),p("segments","Segments",6,4,32,"uLayerMandalaSegments"),s("rotation","Rotation",.2,-1,1,"uLayerMandalaRotation"),{id:"symmetry",label:"Symmetry",type:"boolean",default:!0,uniform:"uLayerMandalaSymmetry",randomizable:!0,ui:{shortLabel:"Sym",tooltip:"Toggle mirrored symmetry on/off"}}],shaderPath:"layers/mandala.glsl",randomizable:!0},{id:"kaleidoscope",label:"Kaleidoscope",description:"Sacred geometry mirroring",properties:[...d("kaleidoscope"),p("slices","Slices",6,6,24,"uLayerKaleidoscopeSlices"),s("feedback","Feedback",.5,0,.95,"uLayerKaleidoscopeFeedback"),s("distortion","Distortion",.5,0,2,"uLayerKaleidoscopeDistortion"),s("raymarchMode","3D Mode",0,0,1,"uLayerKaleidoscopeRaymarchMode",.05,!0,0,.7)],shaderPath:"layers/kaleidoscope.glsl",randomizable:!0},{id:"metatron",label:"Metatron's Cube",description:"Sacred geometry with nested rings",properties:[...d("metatron"),p("rings","Rings",2,1,10,"uLayerMetatronRings"),s("thickness","Thickness",.008,.001,.02,"uLayerMetatronThickness",.001,!0,.003,.015),s("spin","Spin",.5,-2,2,"uLayerMetatronSpin")],shaderPath:"layers/metatron.glsl",randomizable:!0},{id:"lissajous",label:"Lissajous",description:"Symmetric line trails",properties:[...d("lissajous"),{id:"frequencies",label:"Complexity",type:"float",default:3,min:1,max:10,step:.1,uniform:"uLayerLissajousFrequencies",randomizable:!0,randomMin:2,randomMax:8,ui:{shortLabel:"Cplx",tooltip:"Curve frequency ratio / knot complexity"}},{id:"slices",label:"Symmetry",type:"int",default:8,min:3,max:24,step:1,uniform:"uLayerLissajousSlices",randomizable:!0,randomMin:4,randomMax:16,ui:{shortLabel:"Sym",tooltip:"Kaleidoscope slices (higher = more symmetry)"}},{id:"damping",label:"Trail Decay",type:"float",default:.1,min:0,max:1,step:.01,uniform:"uLayerLissajousDamping",randomizable:!0,randomMin:0,randomMax:.8,ui:{shortLabel:"Decy",tooltip:"Higher = shorter trail"}},{id:"thickness",label:"Line Width",type:"float",default:.008,min:.001,max:.02,step:.001,uniform:"uLayerLissajousThickness",randomizable:!0,randomMin:.003,randomMax:.012,ui:{shortLabel:"Line",tooltip:"Line thickness"}}],shaderPath:"layers/lissajous.glsl",randomizable:!0},{id:"cymatics",label:"Cymatics",description:"Standing-wave nodal line patterns",properties:[...d("cymatics"),{id:"mode",label:"Pattern Style",type:"select",default:0,options:[{value:0,label:"Plate"},{value:1,label:"Radial"},{value:2,label:"Hybrid"}],uniform:"uLayerCymaticsMode",randomizable:!0,ui:{shortLabel:"Style",tooltip:"Plate = grid-like patterns, Radial = circular patterns, Hybrid = mix of both"}},{id:"m",label:"Pattern Detail",type:"int",default:5,min:1,max:16,step:1,uniform:"uLayerCymaticsM",randomizable:!0,randomMin:2,randomMax:12,ui:{shortLabel:"Detail",tooltip:"Higher = more intricate pattern with more lines"}},{id:"n",label:"Pattern Complexity",type:"int",default:8,min:1,max:16,step:1,uniform:"uLayerCymaticsN",randomizable:!0,randomMin:3,randomMax:16,ui:{shortLabel:"Cplx",tooltip:"Higher = more complex wave patterns"}},{id:"thickness",label:"Line Width",type:"float",default:.06,min:.005,max:.2,step:.001,uniform:"uLayerCymaticsThickness",randomizable:!0,randomMin:.02,randomMax:.12,ui:{shortLabel:"Width",tooltip:"Thickness of the pattern lines (thinner = more delicate)"}},{id:"sharpness",label:"Line Sharpness",type:"float",default:1.4,min:.35,max:4,step:.05,uniform:"uLayerCymaticsSharpness",randomizable:!0,randomMin:.7,randomMax:2.6,ui:{shortLabel:"Sharp",tooltip:"Higher = crisper, more defined lines (lower = softer, more blurred)"}},{id:"warp",label:"Flow Distortion",type:"float",default:.35,min:0,max:1,step:.01,uniform:"uLayerCymaticsWarp",randomizable:!0,randomMin:0,randomMax:.85,ui:{shortLabel:"Flow",tooltip:"Adds flowing, wavy distortion to the pattern (0 = straight lines, higher = more movement)"}}],shaderPath:"layers/cymatics.glsl",randomizable:!0},{id:"turbulence",label:"Turbulence",description:"Audio-reactive turbulence",properties:[...d("turbulence"),p("complexity","Complexity",3,1,6,"uLayerTurbulenceComplexity"),s("flow","Flow",.5,-1,1,"uLayerTurbulenceFlow")],shaderPath:"layers/turbulence.glsl",randomizable:!0},{id:"displacement",label:"Displacement",description:"Cellular displacement waves",properties:[...d("displacement"),s("strength","Strength",.5,0,2,"uLayerDisplacementStrength"),s("cellSize","Cell Size",1,.1,5,"uLayerDisplacementCellSize"),s("ripple","Ripple",1,0,3,"uLayerDisplacementRipple")],shaderPath:"layers/displacement.glsl",randomizable:!0},{id:"glow",label:"Center Glow",description:"Pulsing core with arcs",properties:[...d("glow"),s("coreSize","Core Size",.5,.1,2,"uLayerGlowCoreSize"),p("ringCount","Ring Count",3,0,10,"uLayerGlowRingCount"),s("arcIntensity","Arc Intensity",.5,0,10,"uLayerGlowArcIntensity")],shaderPath:"layers/glow.glsl",randomizable:!0},{id:"starfield",label:"Starfield",description:"Warp tunnel streaks",properties:[...d("starfield"),s("density","Density",1,.1,3,"uLayerStarfieldDensity"),s("warp","Warp",1,.1,5,"uLayerStarfieldWarp"),p("layers","Layers",4,1,8,"uLayerStarfieldLayers")],shaderPath:"layers/starfield.glsl",randomizable:!0},{id:"hopalong",label:"Hopalong Orbits",description:"Barry Martin attractor with kaleidoscope splits",properties:[...d("hopalong"),s("divergence","Divergence",1,.1,5,"uLayerHopalongDivergence"),p("iterations","Iterations",5,1,10,"uLayerHopalongIterations"),p("slices","Slices",1,1,16,"uLayerHopalongSlices",1,!0,1,12),s("rotation","Rotation",0,-1,1,"uLayerHopalongRotation",.01,!0,-.5,.5)],shaderPath:"layers/hopalong.glsl",randomizable:!0},{id:"fractal",label:"Fractal Pattern",description:"Fractal patterns with palette-based coloring",properties:[...d("fractal"),s("iterations","Iterations",3.5,1,5,"uLayerFractalIterations",.1,!0,2,4.5),s("scale","Scale",1,.1,4,"uLayerFractalScale",.05,!0,.3,1.5),s("power","Power",1.2,.5,2.5,"uLayerFractalPower",.05,!0,.8,1.8)],shaderPath:"layers/fractal.glsl",randomizable:!0}];class z{gl;program=null;uniformLocations={};mouseUniformLocations={};gestureUniformLocations={};layerUniformLocations=new Map;feedbackTexture=null;feedbackReady=!1;feedbackWidth=0;feedbackHeight=0;gestureData=null;positionBuffer=null;initialized=!1;width=0;height=0;uniformCache=new Map;qualityLevel=1;feedbackEnabled=!0;constructor(e){this.gl=e}async init(){const e=this.gl;try{if(this.program=await F(e,"quad.vert","composite.frag"),!this.program)return console.error("WorkerRenderer: Failed to create shader program"),!1}catch(i){return console.error("WorkerRenderer: Failed to load shaders:",i),!1}this.uniformLocations={time:e.getUniformLocation(this.program,"uTime"),resolution:e.getUniformLocation(this.program,"uResolution"),beat:e.getUniformLocation(this.program,"uBeat"),energy:e.getUniformLocation(this.program,"uEnergy"),treble:e.getUniformLocation(this.program,"uTreble"),feedbackTexture:e.getUniformLocation(this.program,"uFeedbackTex"),feedbackReady:e.getUniformLocation(this.program,"uFeedbackReady"),qualityLevel:e.getUniformLocation(this.program,"uQualityLevel")},this.mouseUniformLocations={position:e.getUniformLocation(this.program,"uMouse"),velocity:e.getUniformLocation(this.program,"uMouseVelocity"),speed:e.getUniformLocation(this.program,"uMouseSpeed"),down:e.getUniformLocation(this.program,"uMouseDown"),click:e.getUniformLocation(this.program,"uMouseClick")},this.gestureUniformLocations={handPositions:[e.getUniformLocation(this.program,"uGestureHandPositions[0]"),e.getUniformLocation(this.program,"uGestureHandPositions[1]"),e.getUniformLocation(this.program,"uGestureHandPositions[2]"),e.getUniformLocation(this.program,"uGestureHandPositions[3]")],handCount:e.getUniformLocation(this.program,"uGestureHandCount"),faceCenter:e.getUniformLocation(this.program,"uFaceCenter"),faceDetected:e.getUniformLocation(this.program,"uFaceDetected")};for(const i of C)for(const o of i.properties){const n=e.getUniformLocation(this.program,o.uniform);this.layerUniformLocations.set(o.uniform,n)}this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer);const a=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]);e.bufferData(e.ARRAY_BUFFER,a,e.STATIC_DRAW);const t=e.getAttribLocation(this.program,"aPosition");return e.enableVertexAttribArray(t),e.vertexAttribPointer(t,2,e.FLOAT,!1,0,0),this.feedbackTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.feedbackTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([0,0,0,255])),this.initialized=!0,!0}resize(e,a){if(!this.gl)return;const t=Math.floor(e),i=Math.floor(a);this.width=t,this.height=i,this.gl.viewport(0,0,t,i),this.feedbackTexture&&(this.gl.bindTexture(this.gl.TEXTURE_2D,this.feedbackTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGB,t,i,0,this.gl.RGB,this.gl.UNSIGNED_BYTE,null),this.feedbackWidth=t,this.feedbackHeight=i),this.feedbackReady=!1}updateLayers(e){if(!(!this.gl||!this.program)){this.gl.useProgram(this.program);for(const a of e)for(const[t,i]of Object.entries(a.uniforms))this.setUniform(t,i)}}updateMouse(e){!this.gl||!this.program||(this.gl.useProgram(this.program),this.gl.uniform2f(this.mouseUniformLocations.position,e.x,e.y),this.gl.uniform2f(this.mouseUniformLocations.velocity,e.velocityX,e.velocityY),this.gl.uniform1f(this.mouseUniformLocations.speed,e.speed),this.gl.uniform1f(this.mouseUniformLocations.down,e.down),this.gl.uniform2f(this.mouseUniformLocations.click,e.clickX,e.clickY))}render(e,a){if(!this.gl||!this.program||!this.initialized)return;const t=this.gl;t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT),t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer);const i=t.getAttribLocation(this.program,"aPosition");if(t.enableVertexAttribArray(i),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0),t.uniform1f(this.uniformLocations.time,e),t.uniform2f(this.uniformLocations.resolution,this.width,this.height),t.uniform1f(this.uniformLocations.beat,a.beat),t.uniform1f(this.uniformLocations.energy,a.energy),t.uniform1f(this.uniformLocations.treble,a.treble),t.uniform1f(this.uniformLocations.qualityLevel,this.qualityLevel),this.gestureUniformLocations.handCount){const o=this.gestureData?.hands?.length||0;t.uniform1f(this.gestureUniformLocations.handCount,Math.min(o,4));for(let n=0;n<4;n++){const c=this.gestureUniformLocations.handPositions[n];if(c&&this.gestureData?.hands?.[n]?.center){const m=this.gestureData.hands[n];t.uniform2f(c,m.center.x,m.center.y)}else c&&t.uniform2f(c,.5,.5)}}if(this.gestureUniformLocations.faceCenter&&this.gestureUniformLocations.faceDetected)if(this.gestureData?.faces&&this.gestureData.faces.length>0){const o=this.gestureData.faces[0];t.uniform2f(this.gestureUniformLocations.faceCenter,o.center.x,o.center.y),t.uniform1f(this.gestureUniformLocations.faceDetected,1)}else t.uniform2f(this.gestureUniformLocations.faceCenter,.5,.5),t.uniform1f(this.gestureUniformLocations.faceDetected,0);if(t.activeTexture(t.TEXTURE0),this.feedbackEnabled&&this.feedbackTexture&&this.feedbackReady?t.bindTexture(t.TEXTURE_2D,this.feedbackTexture):t.bindTexture(t.TEXTURE_2D,null),t.uniform1i(this.uniformLocations.feedbackTexture,0),t.uniform1f(this.uniformLocations.feedbackReady,this.feedbackEnabled&&this.feedbackReady?1:0),t.bindBuffer(t.ARRAY_BUFFER,this.positionBuffer),t.enableVertexAttribArray(i),t.vertexAttribPointer(i,2,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLES,0,6),this.feedbackEnabled&&this.width>0&&this.height>0&&this.feedbackTexture){t.bindTexture(t.TEXTURE_2D,this.feedbackTexture);const o=Math.min(this.feedbackWidth,t.drawingBufferWidth,this.width),n=Math.min(this.feedbackHeight,t.drawingBufferHeight,this.height);o>0&&n>0&&(t.copyTexSubImage2D(t.TEXTURE_2D,0,0,0,0,0,o,n),this.feedbackReady=!0)}}updateQualityLevel(e){this.qualityLevel=e}updateFeedbackEnabled(e){this.feedbackEnabled=e}updateGestures(e){this.gestureData=e}setUniform(e,a){if(this.uniformCache.get(e)===a)return;const t=this.layerUniformLocations.get(e);t&&(this.gl.uniform1f(t,a),this.uniformCache.set(e,a))}}let y=null,T=null,h=null,b=!1,u=null;const l={energy:0,treble:0,bass:0,mids:0,highs:0,lows:0,beat:0};self.onmessage=async r=>{const e=r.data;switch(e.type){case"INIT":if(y=e.canvas,e.audioBuffer&&(h=new Float32Array(e.audioBuffer)),e.dpr,T=y.getContext("webgl",{antialias:!1,preserveDrawingBuffer:!0,alpha:!1}),!T){console.error("Worker: WebGL not supported");return}if(u=new z(T),!await u.init()){console.error("Worker: Failed to initialize renderer");return}b=!0,requestAnimationFrame(k);break;case"RESIZE":if(y){const t=e.width*e.dpr,i=e.height*e.dpr;y.width=t,y.height=i,e.dpr,u?.resize(t,i)}break;case"UPDATE_CONFIG":u?.updateLayers(e.layers);break;case"UPDATE_PARAMS":u?.updateMouse(e.mouse);break;case"UPDATE_MOUSE":u?.updateMouse(e.mouse);break;case"SET_AUDIO_BUFFER":h=new Float32Array(e.audioBuffer);break;case"UPDATE_AUDIO":e.metrics&&(l.energy=e.metrics.energy,l.treble=e.metrics.treble,l.bass=e.metrics.bass,l.mids=e.metrics.mids,l.highs=e.metrics.highs,l.lows=e.metrics.lows,l.beat=e.metrics.beat);break;case"UPDATE_QUALITY":u?.updateQualityLevel(e.quality);break;case"UPDATE_FEEDBACK":u?.updateFeedbackEnabled(e.enabled);break;case"CAMERA_FRAME":u?.updateCameraFrame(e.bitmap),e.gestures&&u?.updateGestures(e.gestures);break;case"UPDATE_GESTURES":u?.updateGestures(e.gestures);break;case"PAUSE":b=!1;break;case"RESUME":b||(b=!0,requestAnimationFrame(k));break}};function I(){h&&(l.energy=h[g.energy],l.treble=h[g.treble],l.bass=h[g.bass],l.mids=h[g.mids],l.highs=h[g.highs],l.lows=h[g.lows],l.beat=h[g.beat])}let P=0,S=0,R=0;function k(r){if(!(!b||!T)){if(I(),u?.render(r/1e3,l),S++,r-R>=1e3){const e=Math.round(S*1e3/(r-R));self.postMessage({type:"STATS",fps:e,frameTime:r-P}),R=r,S=0}P=r,requestAnimationFrame(k)}}})();
